<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>IMACX Account System</title>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <script src="https://unpkg.com/scrollreveal"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/store2@2.14.2/dist/store2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.4/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/idb-keyval.iife.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css" />

    <script src="https://cdn.jsdelivr.net/npm/nanoid/nanoid.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(ellipse at center, #050505 0%, #0d0d0d 100%);
            color: #ffffff;
        }
        .title-glow {
            font-family: 'Unbounded', cursive;
            background: linear-gradient(to right, #fff, #ffd700, #f5c518);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
        }
        .glass-box {
            backdrop-filter: blur(15px);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem;
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        input, select, button {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            color: black;
        }
        input::placeholder {
            color: #888;
        }
        input, select {
            color: #000 !important;
            background-color: #fff;
        }
        .error-message {
            color: #ff4d4d;
            font-size: 0.9rem;
            margin-top: 0.2rem;
        }
    </style>
</head>
<body>
    <section class="p-6 max-w-4xl mx-auto">
        <h1 class="text-5xl text-center title-glow mb-10">IMACX Account Portal</h1>

        <div class="glass-box">
            <h2 class="text-2xl mb-4">Login</h2>
            <input id="login-user" type="text" placeholder="Username" class="w-full p-2 rounded bg-white text-black">
            <input id="login-pass" type="password" placeholder="Password" class="w-full p-2 rounded bg-white text-black">
            <button id="login-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Login</button>
            <p id="login-msg" class="text-red-500"></p>
        </div>

        <div class="glass-box">
            <h2 class="text-2xl mb-4">Sign Up</h2>
            <input id="signup-user" type="text" placeholder="Username" class="w-full p-2 rounded bg-white text-black">
            <p id="signup-user-error" class="error-message"></p>
            <input id="signup-email" type="email" placeholder="Email" class="w-full p-2 rounded bg-white text-black">
            <p id="signup-email-error" class="error-message"></p>
            <div class="flex gap-2 mb-4">
                <select id="signup-country-code" class="p-2 rounded bg-gray-800 text-white border border-gray-600">
                    <option value="+91">+91 India</option>
                    <option value="+1">+1 USA</option>
                    <option value="+44">+44 UK</option>
                </select>
                <input id="signup-phone" type="tel" placeholder="Phone number" class="w-full p-2 rounded bg-white text-black">
            </div>
            <p id="signup-phone-error" class="error-message"></p>
            <input id="signup-pass" type="password" placeholder="Password" class="w-full p-2 rounded bg-white text-black">
            <p id="signup-pass-error" class="error-message"></p>
            <input id="signup-confirm" type="password" placeholder="Confirm Password" class="w-full p-2 rounded bg-white text-black">
            <p id="signup-confirm-error" class="error-message"></p>
            <button id="signup-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Sign Up</button>
            <p id="signup-msg" class="text-green-500"></p>
        </div>

        <div id="recover-password-box" class="glass-box">
            <h2 class="text-2xl mb-4">Recover Password</h2>
            <input id="recover-user" type="text" placeholder="Username" class="w-full p-2 rounded bg-white text-black">
            <p id="recover-user-error" class="error-message"></p>
            <input id="recover-email" type="email" placeholder="Email" class="w-full p-2 rounded bg-white text-black">
            <p id="recover-email-error" class="error-message"></p>
            <div class="flex gap-2 mb-4">
                <select id="recover-country-code" class="p-2 rounded bg-gray-800 text-white border border-gray-600">
                    <option value="+91">+91 India</option>
                    <option value="+1">+1 USA</option>
                    <option value="+44">+44 UK</option>
                </select>
                <input id="recover-phone" type="tel" placeholder="Phone number" class="w-full p-2 rounded bg-white text-black">
            </div>
            <p id="recover-phone-error" class="error-message"></p>
            <button id="recover-pass-btn" class="bg-yellow-500 hover:bg-yellow-700 text-black font-bold py-2 px-4 rounded">Recover Password</button>
            <p id="recover-msg" class="text-blue-500"></p>
        </div>

        <div id="recover-username-box" class="glass-box">
            <h2 class="text-2xl mb-4">Recover Username</h2>
            <input id="username-recovery-email" type="email" placeholder="Email" class="w-full p-2 rounded bg-white text-black">
            <p id="username-recovery-email-error" class="error-message"></p>
            <div class="flex gap-2 mb-4">
                <select id="username-country-code" class="p-2 rounded bg-gray-800 text-white border border-gray-600">
                    <option value="+91">+91 India</option>
                    <option value="+1">+1 USA</option>
                    <option value="+44">+44 UK</option>
                </select>
                <input id="username-phone" type="tel" placeholder="Phone number" class="w-full p-2 rounded bg-white text-black">
            </div>
            <p id="username-phone-error" class="error-message"></p>
            <input id="username-recovery-pass" type="password" placeholder="Password" class="w-full p-2 rounded bg-white text-black">
            <p id="username-recovery-pass-error" class="error-message"></p>
            <button id="recover-username-btn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">Recover Username</button>
            <p id="username-msg" class="text-blue-500"></p>
        </div>

        <div class="glass-box">
            <h2 class="text-2xl mb-4">Account Status</h2>
            <p id="status-info" class="text-gray-400"></p>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded mt-4">Logout</button>
        </div>
    </section>

    <div id="header-placeholder"></div>
    <script>
        fetch("header.html")
            .then(response => {
                if (!response.ok) {
                    console.error("Error loading header:", response.status);
                    return '';
                }
                return response.text();
            })
            .then(data => {
                document.getElementById("header-placeholder").innerHTML = data;
            })
            .catch(error => {
                console.error("Error loading header:", error);
            });
    </script>

    <script type="importmap">
      {
        "imports": {
          "gun": "https://cdn.jsdelivr.net/npm/gun@0.2020/gun.js",
          "gun/sea": "https://cdn.jsdelivr.net/npm/gun@0.2020/sea.js",
          }
      }
    </script>
    <script src="account.js" type="module"></script>
<script>

// account.js
import Gun from 'gun';
import 'gun/sea'; // Optional: For secure data handling with SEA

// Initialize GunDB (using a public peer for global access - consider your own setup)
const gun = Gun(['https://gun.peers.crunk.house/gun']);
console.log('GunDB initialized:', gun);

// Algorithm parameters for PBKDF2
const PBKDF2_ALGORITHM = 'PBKDF2';
const PBKDF2_SALT_LENGTH = 16; // Recommended salt length
const PBKDF2_ITERATIONS = 100000; // High iteration count for security
const PBKDF2_KEY_LENGTH = 256; // Length of the derived key (in bits)
const HASH_ALGORITHM = 'SHA-256';

// Function to get current timestamp in IST
function timestampIST() {
    const date = new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' });
    return new Date(date).toISOString();
}

// --- Utility Functions ---
function isValidUsername(username) {
    return username.length >= 3 && username.length <= 20 && /^[a-zA-Z0-9]+$/.test(username);
}

function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function isValidPhone(phone) {
    return /^\d+$/.test(phone); // Basic check for digits only
    // For more robust validation, consider using a library or more complex regex
}

function isValidPassword(password) {
    return password.length >= 6;
}

function displayError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerText = message;
        console.error(`Error in ${elementId}:`, message);
    } else {
        console.error(`Element with ID "${elementId}" not found for error display.`);
    }
}

function clearError(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerText = '';
    } else {
        console.warn(`Element with ID "${elementId}" not found for clearing error.`);
    }
}

// Function to generate a secure salt using crypto.getRandomValues
function generateSalt() {
    const salt = new Uint8Array(PBKDF2_SALT_LENGTH);
    crypto.getRandomValues(salt);
    return bufferToBase64(salt);
}

// Function to hash password using PBKDF2 with crypto.subtle
async function hashPassword(password, salt) {
    const textEncoder = new TextEncoder();
    const passwordBuffer = textEncoder.encode(password);
    const saltBuffer = base64ToBuffer(salt);

    const keyMaterial = await crypto.subtle.importKey(
        'raw',
        passwordBuffer,
        { name: PBKDF2_ALGORITHM },
        false,
        ['deriveKey']
    );

    const derivedKey = await crypto.subtle.deriveKey(
        {
            name: PBKDF2_ALGORITHM,
            salt: saltBuffer,
            iterations: PBKDF2_ITERATIONS,
            hash: HASH_ALGORITHM,
        },
        keyMaterial,
        { name: 'AES-CBC', length: PBKDF2_KEY_LENGTH }, // Using AES-CBC only to specify key length
        false,
        ['encrypt', 'decrypt'] // These usages are just to satisfy the deriveKey constraints
    );

    const exportedKey = await crypto.subtle.exportKey('raw', derivedKey);
    return bufferToBase64(new Uint8Array(exportedKey));
}

// Helper function to convert buffer to base64
function bufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
}

// Helper function to convert base64 to buffer
function base64ToBuffer(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

// --- Signup Logic ---
document.getElementById('signup-btn')?.addEventListener('click', async (event) => {
    event.preventDefault();
    console.log('Signup button clicked!');

    const usernameInput = document.getElementById('signup-user');
    const emailInput = document.getElementById('signup-email');
    const phoneInput = document.getElementById('signup-phone');
    const passwordInput = document.getElementById('signup-pass');
    const confirmInput = document.getElementById('signup-confirm');
    const countryCodeInput = document.getElementById('signup-country-code');
    const msg = document.getElementById('signup-msg');

    if (!usernameInput || !emailInput || !phoneInput || !passwordInput || !confirmInput || !countryCodeInput || !msg) {
        console.error('One or more signup form elements not found!');
        return;
    }

    const username = usernameInput.value.trim();
    const email = emailInput.value.trim().toLowerCase();
    const phone = phoneInput.value.trim();
    const countryCode = countryCodeInput.value;
    const password = passwordInput.value;
    const confirm = confirmInput.value;

    console.log('Signup Data:', { username, email, phone, countryCode, password, confirm });

    clearError('signup-user-error');
    clearError('signup-email-error');
    clearError('signup-phone-error');
    clearError('signup-pass-error');
    clearError('signup-confirm-error');
    msg.innerText = '';

    let isValid = true;

    if (!isValidUsername(username)) {
        displayError('signup-user-error', 'Username must be 3-20 alphanumeric characters.');
        isValid = false;
    }

    if (!isValidEmail(email)) {
        displayError('signup-email-error', 'Invalid email address.');
        isValid = false;
    }

    if (!isValidPhone(phone)) {
        displayError('signup-phone-error', 'Invalid phone number.');
        isValid = false;
    }

    if (!isValidPassword(password)) {
        displayError('signup-pass-error', 'Password must be at least 6 characters.');
        isValid = false;
    }

    if (password !== confirm) {
        displayError('signup-confirm-error', 'Passwords do not match.');
        isValid = false;
    }

    if (!isValid) return;

    const userKey = username;
    console.log('Checking if username exists:', userKey);
    gun.get('imacx-accounts').get(userKey).once(async existing => {
        if (existing) {
            console.log('Username already exists:', existing);
            msg.innerText = 'Username already exists.';
        } else {
            const salt = generateSalt();
            const hashedPassword = await hashPassword(password, salt);

            const user = {
                username,
                email,
                phone: `${countryCode}${phone}`,
                password: hashedPassword, // Store the derived key
                salt: salt, // Store the salt
                created: timestampIST()
            };
            console.log('Storing new user:', user);
            gun.get('imacx-accounts').get(userKey).put(user, ack => {
                console.log('Signup ACK:', ack);
                if (ack.err) {
                    msg.innerText = 'Error creating account on GunDB.';
                    console.error('GunDB error:', ack.err);
                } else {
                    msg.innerText = 'Account created successfully!';
                    usernameInput.value = '';
                    emailInput.value = '';
                    phoneInput.value = '';
                    passwordInput.value = '';
                    confirmInput.value = '';
                }
            });
        }
    });
});

// --- Login Logic ---
document.getElementById('login-btn')?.addEventListener('click', async (event) => {
    event.preventDefault();
    console.log('Login button clicked!');

    const usernameInput = document.getElementById('login-user');
    const passwordInput = document.getElementById('login-pass');
    const msg = document.getElementById('login-msg');
    const statusInfo = document.getElementById('status-info');

    if (!usernameInput || !passwordInput || !msg || !statusInfo) {
        console.error('One or more login form elements not found!');
        return;
    }

    const username = usernameInput.value.trim();
    const password = passwordInput.value;

    console.log('Login Attempt:', { username, password });
    msg.innerText = '';

    if (!username || !password) {
        msg.innerText = 'Enter both username and password.';
        return;
    }

    gun.get('imacx-accounts').get(username).once(async data => {
        console.log('Login data retrieved:', data);
        if (data && data.password && data.salt) {
            const hashedPasswordAttempt = await hashPassword(password, data.salt);
            if (hashedPasswordAttempt === data.password) {
                msg.innerText = 'Login successful!';
                statusInfo.innerText = `Logged in as ${username}, created at ${data.created}`;
                localStorage.setItem('loggedInUser', username);
                localStorage.setItem('accountId', username); // Store account ID for cross-page access
                // loadAccountData(username); // Load user-specific data
            } else {
                msg.innerText = 'Invalid login credentials.';
            }
        } else {
            msg.innerText = 'Invalid login credentials.';
        }
    });
});

// --- Recover Password Logic ---
document.getElementById('recover-pass-btn')?.addEventListener('click', async (event) => {
    event.preventDefault();
    console.log('Recover Password button clicked!');

    const usernameInput = document.getElementById('recover-user');
    const emailInput = document.getElementById('recover-email');
    const phoneInput = document.querySelector('#recover-password-box input[type="tel"]');
    const countryCodeInput = document.querySelector('#recover-password-box select');
    const msg = document.getElementById('recover-msg');

    if (!usernameInput || !emailInput || !phoneInput || !countryCodeInput || !msg) {
        console.error('One or more recover password elements not found!');
        return;
    }

    const username = usernameInput.value.trim();
    const email = emailInput.value.trim().toLowerCase();
    const phone = phoneInput.value.trim();
    const countryCode = countryCodeInput.value;

    console.log('Recover Password Attempt:', { username, email, phone, countryCode });

    clearError('recover-user-error');
    clearError('recover-email-error');
    clearError('recover-phone-error');
    msg.innerText = '';

    let isValid = true;

    if (!isValidUsername(username)) {
        displayError('recover-user-error', 'Invalid username format.');
        isValid = false;
    }

    if (!isValidEmail(email)) {
        displayError('recover-email-error', 'Invalid email address.');
        isValid = false;
    }

    if (!isValidPhone(phone)) {
        displayError('recover-phone-error', 'Invalid phone number format.');
        isValid = false;
    }

    if (!isValid) return;

    gun.get('imacx-accounts').get(username).once(data => {
        console.log('Recover Password Data Retrieved:', data);
        if (!data) {
            msg.innerText = 'No account found with that username.';
            return;
        }

        if (data.email === email && data.phone === `${countryCode}${phone}`) {
            msg.innerText = `Contact support to recover your password.`; // Implement a real password reset flow
        } else {
            msg.innerText = 'Information does not match. Cannot recover password.';
        }
    });
});

// --- Recover Username Logic ---
document.getElementById('recover-username-btn')?.addEventListener('click', async (event) => {
    event.preventDefault();
    console.log('Recover Username button clicked!');

    const emailInput = document.getElementById('username-recovery-email');
    const phoneInput = document.querySelector('#recover-username-box input[type="tel"]');
    const countryCodeInput = document.querySelector('#recover-username-box select');
    const passwordInput = document.getElementById('username-recovery-pass');
    const msg = document.getElementById('username-msg');

    if (!emailInput || !phoneInput || !countryCodeInput || !passwordInput || !msg) {
        console.error('One or more recover username elements not found!');
        return;
    }

    const email = emailInput.value.trim().toLowerCase();
    const phone = phoneInput.value.trim();
    const countryCode = countryCodeInput.value;
    const password = passwordInput.value;

    console.log('Recover Username Attempt:', { email, phone, countryCode, password });

    clearError('username-recovery-email-error');
    clearError('username-phone-error');
    clearError('username-recovery-pass-error');
    msg.innerText = '';

    let isValid = true;

    if (!isValidEmail(email)) {
        displayError('username-recovery-email-error', 'Invalid email address.');
        isValid = false;
    }

    if (!isValidPhone(phone)) {
        displayError('username-phone-error', 'Invalid phone number format.');
        isValid = false;
    }

    if (!isValidPassword(password)) {
        displayError('username-recovery-pass-error', 'Password must be at least 6 characters.');
        isValid = false;
    }

    if (!isValid) return;

    gun.get('imacx-accounts').map().once(async data => {
        console.log('Recover Username Data Iterated:', data);
        if (data && data.email === email && data.phone === `${countryCode}${phone}`) {
            const hashedPasswordAttempt = await hashPassword(password, data.salt);
            if (hashedPasswordAttempt === data.password) {
                msg.innerText = `Your username is: ${data.username}`;
            } else {
                msg.innerText = 'Could not verify account.';
            }
        }
    });

    setTimeout(() => {
        if (!msg.innerText.startsWith('Your username')) {
            msg.innerText = 'No matching account found with provided details.';
        }
    }, 2000);
});

// --- Account Data Handling and Cross-Page Persistence ---
function saveAccountData(accountId, key, value) {
    if (accountId) {
        gun.get('imacx-account-data').get(accountId).put({ [key]: value });
        console.log(`Data saved for account ${accountId}: ${key} - ${value}`);
    } else {
        console.warn('Account ID not available to save data.');
    }
}

function loadAccountData(accountId) {
    if (accountId) {
        gun.get('imacx-account-data').get(accountId).once(data => {
            console.log(`Account data loaded for ${accountId}:`, data);
            // Update UI with loaded data (you'll need to implement this)
        });
    } else {
        console.warn('Account ID not available to load data.');
    }
}

function checkLoggedInStatus() {
    const loggedInUser = localStorage.getItem('loggedInUser');
    const accountId = localStorage.getItem('accountId');
    const statusInfo = document.getElementById('status-info');
    if (loggedInUser && accountId && statusInfo) {
        statusInfo.innerText = `Logged in as ${loggedInUser} (Persistent)`;
        // loadAccountData(accountId); // Load account data on page load if logged in
    }
}

function logout() {
    localStorage.removeItem('loggedInUser');
    localStorage.removeItem('accountId');
    const statusInfo = document.getElementById('status-info');
    if (statusInfo) {
        statusInfo.innerText = 'Logged out';
    }
    console.log('Logged out.');
    // Optionally redirect to login page
}

document.getElementById('logout-btn')?.addEventListener('click', logout);
checkLoggedInStatus();

// --- Disconnect/Connect Handling (GunDB handles this automatically) ---
gun.on('opt', function(opt){
    console.log("Gun is configured:", opt);
});

gun.on('hi', function(peer){
    console.log("Connected to peer:", peer);
});

gun.on('bye', function(peer){
    console.log("Disconnected from peer:", peer);
});

console.log('Account script loaded with crypto.subtle and vanilla validation.');    
</script>
</body>
</html>
